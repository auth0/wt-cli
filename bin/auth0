#!/usr/bin/env node
var Chalk = require('chalk');
var Cli = require('structured-cli');
var Package = require('../package.json');
var Updates = require('update-notifier');
var Auth0Extensions = require('./auth0_extensions');
var _ = require('lodash');


var notifier = Updates({
    pkg: {
        name: Package.name,
        version: Package.version,
    },
});

notifier.notify();


var cli = Cli.createApp({
    description: 'Auth0 Command Line Interface',
    version: Package.version
});

Object.keys(Auth0Extensions).sort().forEach(function (extensionName) {
    var extensionCategory = new Cli.createCategory(extensionName, {
        description: Auth0Extensions[extensionName].description
    });
    extensionCategory.addChild(require('./auth0_ls')(extensionName));
    extensionCategory.addChild(require('./auth0_create')(extensionName));
    extensionCategory.addChild(require('./auth0_toggle')(extensionName, 'enable'));
    extensionCategory.addChild(require('./auth0_toggle')(extensionName, 'disable'));
    extensionCategory.addChild(require('./auth0_scaffold')(extensionName));
    cli.addChild(extensionCategory);
});

cli.addChild(require('./auth0_ls')());
cli.addChild(require('./edit'));
cli.addChild(require('./rm'));
cli.addChild(require('./logs'));

Cli.run(cli)
    .timeout(1000 * 60 * 30, Cli.error.timeout('Command timed out after 30 min'))
    // Code: 1
    .catch(_.matchesProperty('code', 'E_CANCELLED'), function (err) {
        console.error(err.message);
        
        process.exit(1);
    })
    // Code: 2
    .catch(_.matchesProperty('code', 'E_INVALID'), function (err) {
        console.error(err.parser.formatUsage());
        console.error(Chalk.red(err.message));
        
        process.exit(2);
    })
    // Code: 3
    .catch(_.matchesProperty('code', 'E_HINT'), function (err) {
        console.error(err.message);
        
        process.exit(3);
    })
    // Code: 4
    .catch(_.matchesProperty('code', 'E_TIMEOUT'), function (err) {
        console.error(Chalk.red(err.message));
        
        process.exit(4);
    })
    // Code: 5
    .catch(_.matchesProperty('code', 'E_NOTFOUND'), function (err) {
        console.error(Chalk.red(err.message));
        
        process.exit(5);
    })
    // Code: 6
    .catch(_.matchesProperty('code', 'E_BADREQUEST'), function (err) {
        console.error(Chalk.red(err.message));
        
        process.exit(6);
    })
    // Code: 7
    .catch(_.matchesProperty('code', 'E_SERVERERROR'), function (err) {
        console.error(Chalk.red(err.message));
        
        process.exit(7);
    })
    // Code: 8
    .catch(_.matchesProperty('code', 'E_NOTAUTHORIZED'), function (err) {
        console.error(Chalk.red(err.message));
        
        process.exit(8);
    })    // Code: 99
    .catch(function (err) {
        console.error(Chalk.red('Uncaught error: ', err.message));
        console.error(err.stack);
        console.error('Please report this at: https://github.com/auth0/wt-cli/issues');
        
        process.exit(99);
    })
    .then(function () {
        process.exit(0);
    });
